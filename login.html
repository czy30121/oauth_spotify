<!DOCTYPE html>
<html lang="">
	<head>
		<meta charset="utf-8" />
		<title>Link Spotify to Mamamia</title>
		<meta name="description" content="Link Spotify to Mamamia" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="https://firebasestorage.googleapis.com/v0/b/mamamia-pwa.appspot.com/o/login.css?alt=media" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&display=swap" rel="stylesheet" />

		<meta name="theme-color" content="#fafafa" />
	</head>

	<body>
		<main>
			<div id="main-container" class="container">
				<div class="header">
					<svg class="small-m-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 18.294">
						<g id="Group_2633" data-name="Group 2633" transform="translate(-519 -489)">
							<path
								id="Path_10988"
								data-name="Path 10988"
								d="M62.181-321.934h3.4a.292.292,0,0,1,.284.225l1.708,7.217a.292.292,0,0,0,.568,0l1.728-7.218a.292.292,0,0,1,.284-.224h3.382a.292.292,0,0,1,.292.292v15.676a.292.292,0,0,1-.292.292H71.252a.292.292,0,0,1-.292-.292V-312.3a.292.292,0,0,0-.576-.066L68.877-305.9a.292.292,0,0,1-.284.226H67.079a.292.292,0,0,1-.284-.223l-1.6-6.572a.292.292,0,0,0-.576.069v6.434a.292.292,0,0,1-.292.292H62.181a.292.292,0,0,1-.292-.292v-15.676a.292.292,0,0,1,.292-.292Z"
								transform="translate(457.111 812.968)"
							/>
							<path id="Path_10989" data-name="Path 10989" d="M258.543-352.713h1.368a.751.751,0,0,1,.751.751v10.6a.751.751,0,0,1-.751.751h-1.368a.751.751,0,0,1-.751-.751v-10.6a.751.751,0,0,1,.751-.751Z" transform="translate(274.154 841.713)" />
							<path id="Path_10990" data-name="Path 10990" d="M260.495-156.554a1.541,1.541,0,0,1-1.811,1.811,1.534,1.534,0,0,1-1.209-1.209,1.541,1.541,0,0,1,1.811-1.811,1.533,1.533,0,0,1,1.209,1.209Z" transform="translate(274.477 659.672)" />
						</g>
					</svg>
					<span>Sign in with Mamamia</span>
				</div>
				<div class="cta-section">
					<div class="logo" id="logo">
						<svg xmlns="http://www.w3.org/2000/svg" width="63" height="63" viewBox="0 0 63 63">
							<g id="Group_3436" data-name="Group 3436" transform="translate(-450 -848)">
								<circle id="Ellipse_1463" data-name="Ellipse 1463" cx="31.5" cy="31.5" r="31.5" transform="translate(450 848)" />
								<g id="Group_2633" data-name="Group 2633" transform="translate(466.893 863.114)">
									<path
										id="Path_10988"
										data-name="Path 10988"
										d="M62.407-321.937h6.036a.518.518,0,0,1,.506.4l3.029,12.8a.517.517,0,0,0,.5.4.517.517,0,0,0,.5-.4l3.064-12.8a.518.518,0,0,1,.506-.4h6a.518.518,0,0,1,.518.518v27.8a.518.518,0,0,1-.518.518H78.493a.518.518,0,0,1-.518-.518v-11.227a.518.518,0,0,0-.459-.514.518.518,0,0,0-.563.4l-2.671,11.463a.518.518,0,0,1-.506.4H71.093a.517.517,0,0,1-.5-.4l-2.832-11.655a.518.518,0,0,0-.565-.392.518.518,0,0,0-.456.514v11.41a.517.517,0,0,1-.152.366.517.517,0,0,1-.366.151H62.408a.518.518,0,0,1-.518-.518v-27.795a.518.518,0,0,1,.518-.518Z"
										transform="translate(-61.89 325.543)"
										fill="#fff"
									/>
									<path
										id="Path_10989"
										data-name="Path 10989"
										d="M259.124-352.713h2.427a1.332,1.332,0,0,1,1.332,1.332v18.8a1.332,1.332,0,0,1-1.332,1.332h-2.428a1.332,1.332,0,0,1-1.332-1.332v-18.8A1.332,1.332,0,0,1,259.124-352.713Z"
										transform="translate(-234.837 352.713)"
										fill="#fff"
									/>
									<path
										id="Path_10990"
										data-name="Path 10990"
										d="M262.851-155.6a2.731,2.731,0,0,1-.747,2.465,2.731,2.731,0,0,1-2.465.747,2.721,2.721,0,0,1-2.143-2.143,2.731,2.731,0,0,1,.747-2.465,2.731,2.731,0,0,1,2.465-.747,2.719,2.719,0,0,1,2.144,2.144Z"
										transform="translate(-234.53 180.634)"
										fill="#ef3f9e"
									/>
								</g>
							</g>
						</svg>
					</div>
					<h1>Sign in</h1>
					<span>to continue to <b>Spotify</b></span>
				</div>
				<div class="form-area">
					<div class="mm-spinner-component">
						<div class="spinner">
							<svg class="spinner-svg" xmlns="http://www.w3.org/2000/svg" width="20.116" height="23" viewBox="0 0 20.116 23">
								<g id="Group_2464" data-name="Group 2464" transform="translate(-61.889 352.713)">
									<path
										id="Path_10988"
										data-name="Path 10988"
										d="M62.256-321.934h4.28a.367.367,0,0,1,.357.282l2.148,9.073a.367.367,0,0,0,.714,0l2.172-9.075a.367.367,0,0,1,.357-.282h4.252a.367.367,0,0,1,.367.367v19.708a.367.367,0,0,1-.367.367H73.661a.367.367,0,0,1-.367-.367v-7.961a.367.367,0,0,0-.725-.083l-1.894,8.128a.367.367,0,0,1-.357.284h-1.9a.367.367,0,0,1-.357-.28l-2.009-8.263a.367.367,0,0,0-.724.087v8.09a.367.367,0,0,1-.367.367h-2.7a.367.367,0,0,1-.367-.367v-19.708a.367.367,0,0,1,.367-.367Z"
										transform="translate(0 -28.222)"
										fill="#000"
									/>
									<path id="Path_10989" data-name="Path 10989" d="M258.736-352.713h1.72a.944.944,0,0,1,.944.944v13.327a.944.944,0,0,1-.944.944h-1.72a.944.944,0,0,1-.944-.944v-13.327a.944.944,0,0,1,.944-.944Z" transform="translate(-179.627)" fill="#000" />
									<path id="Path_10990" data-name="Path 10990" d="M261.279-156.236A1.938,1.938,0,0,1,259-153.959a1.929,1.929,0,0,1-1.52-1.52,1.938,1.938,0,0,1,2.277-2.277,1.928,1.928,0,0,1,1.52,1.52Z" transform="translate(-179.309 -178.727)" fill="#ef3f9e" />
								</g>
							</svg>
							<div class="spin s-1">
								<div>
									<div class="spin s-2"></div>
								</div>
							</div>
						</div>
					</div>
					<div class="container-login">
						<form id="loginForm" method="post">
							<div class="container-input-wrap">
								<div id="input-email" class="container-input activated focused">
									<input type="email" name="email" id="email" class="input" />
									<div class="container-label">
										<div class="container-label--lead label-border"></div>
										<div class="container-label--notch label-border">
											<label class="float-label" for="email">Email<span class="error-emphasis">*</span></label>
										</div>
										<div class="container-label--trailing label-border"></div>
									</div>
								</div>
								<div class="container-helper-text" role="alert">
									<span>User account does not exist</span>
								</div>
							</div>

							<div class="container-input-wrap">
								<div id="input-password" class="container-input">
									<input type="password" name="password" id="password" class="input" />
									<div class="container-label">
										<div class="container-label--lead label-border"></div>
										<div class="container-label--notch label-border">
											<label class="float-label" for="password">Password<span class="error-emphasis">*</span></label>
										</div>
										<div class="container-label--trailing label-border"></div>
									</div>
								</div>
								<div class="container-helper-text" role="alert">
									<span>Incorrect password</span>
								</div>
							</div>
							<button id="submit-button" class="submit" type="button">Sign in</button>
							<a id="forgot-button" href="#" style="display: block; color: var(--mm-pink); text-align: center; margin-top: 15px; font-size: 12px; font-weight: bold">Forgot Password?</a>
							<div id="error-message"></div>
						</form>
					</div>
				</div>
			</div>
		</main>
		<script src="https://www.gstatic.com/firebasejs/8.7.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.7.0/firebase-auth.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

		<script>
			// Avoid `console` errors in browsers that lack a console.
			(function () {
				var method;
				var noop = function () {};
				var methods = [
					"assert",
					"clear",
					"count",
					"debug",
					"dir",
					"dirxml",
					"error",
					"exception",
					"group",
					"groupCollapsed",
					"groupEnd",
					"info",
					"log",
					"markTimeline",
					"profile",
					"profileEnd",
					"table",
					"time",
					"timeEnd",
					"timeline",
					"timelineEnd",
					"timeStamp",
					"trace",
					"warn",
				];
				var length = methods.length;
				var console = (window.console = window.console || {});

				while (length--) {
					method = methods[length];

					// Only stub undefined methods.
					if (!console[method]) {
						console[method] = noop;
					}
				}
			})();

			// Place any jQuery/helper plugins in here.
		</script>

		<script>
			var firebaseConfig = {
				apiKey: "AIzaSyCUOI51BHNs-AbJdC5UBhMuT65Y-m5OilI",
				authDomain: "mamamia-pwa.firebaseapp.com",
				databaseURL: "https://mamamia-pwa.firebaseio.com",
				projectId: "mamamia-pwa",
				storageBucket: "mamamia-pwa.appspot.com",
				messagingSenderId: "231627748683",
				appId: "1:231627748683:web:81802c39bbf93da50724ce",
				measurementId: "G-DCYKG3Q1EV",
			};
			firebase.initializeApp(firebaseConfig);

			const mainContainer = document.getElementById("main-container");

			firebase.auth().onAuthStateChanged((user) => {
				if (user) {
					mainContainer.classList.add("has-spinner");
					user.getIdToken().then(() => handleSpotifyRedirect(user));
				} else {
					document.getElementById("main-container").classList.remove("has-spinner");
				}
			});

			function handleSpotifyRedirect(user) {
				const clientId = "clientId";
				const spotifyUrl = "https://accounts.spotify.com/authorize";
				const urlSearchParams = new URLSearchParams(window.location.search);
				const params = Object.fromEntries(urlSearchParams.entries());
				const redirectUri = "https://us-central1-mamamia-pwa.cloudfunctions.net/callback";

				const queryString = serialize({
					...{
						client_id: clientId,
						response_type: "code",
						redirect_uri: redirectUri,
						state: JSON.stringify({ uid: user.uid, redirectUri }),
					},
					scope: "user-soa-link",
					...params,
				});

				window.location.href = `${spotifyUrl}?` + queryString;
			}

			function serialize(obj) {
				return new URLSearchParams(obj).toString();
			}

			function login() {
				const email = document.getElementById("email").value;
				const password = document.getElementById("password").value;
				firebase
					.auth()
					.signInWithEmailAndPassword(email, password)
					.then((userCredential) => {
						const user = userCredential.user;
						user.getIdToken().then(() => handleSpotifyRedirect(user));
					})
					.catch((error) => {
						const errorCode = error.code;
						const errorMessage = error.message;
						console.log(errorCode, errorMessage);
						switch (errorCode) {
							case "auth/user-not-found":
							case "auth/invalid-email":
								document.getElementById("input-email").classList.add("error");
								break;
							case "auth/wrong-password":
								document.getElementById("input-password").classList.add("error");
								break;
						}
					});
			}

			function reset() {
				const email = document.getElementById("email").value;
				firebase
					.auth()
					.sendPasswordResetEmail(email)
					.then(() => {
						alert("Password reset instruction has been sent to your email.");
					})
					.catch((error) => {
						const errorCode = error.code;
						const errorMessage = error.message;
						switch (errorCode) {
							case "auth/user-not-found":
							case "auth/invalid-email":
								document.getElementById("input-email").classList.add("error");
								break;
						}
					});
			}

			const submit = document.getElementById("submit-button");
			const forgot = document.getElementById("forgot-button");
			const logo = document.getElementById("logo");

			submit.addEventListener("click", login);
			forgot.addEventListener("click", reset);
			logo.addEventListener("click", () => firebase.auth().signOut());

			document.getElementById("email").focus();

			const inputs = document.querySelectorAll(".container-input");
			inputs.forEach((input) => {
				const formInput = input.querySelector(".input");

				formInput.addEventListener("focus", () => {
					input.classList.add("focused", "activated");
				});

				formInput.addEventListener("blur", (e) => {
					input.classList.remove("focused", "error");
					if (input.querySelector(".input").value.length < 1) {
						input.classList.remove("activated");
					}
				});

				input.addEventListener("click", (e) => {
					formInput.focus();
				});
			});
		</script>
	</body>
</html>
